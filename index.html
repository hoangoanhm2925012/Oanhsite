import math
from datetime import date, timedelta

# --- Hằng số vật lý và toán học ---
SOLAR_CONSTANT = 1361  # W/m^2 (Giá trị trung bình của hằng số mặt trời)
DEG_TO_RAD = math.pi / 180  # Hệ số chuyển đổi từ độ sang radian
RAD_TO_DEG = 180 / math.pi  # Hệ số chuyển đổi từ radian sang độ

# --- Các hàm hỗ trợ tính toán hình học mặt trời ---

def get_day_of_year(dt: date) -> int:
    """
    Tính số thứ tự ngày trong năm (DOY) từ một đối tượng ngày (datetime.date).
    Ví dụ: Ngày 1 tháng 1 là 1, ngày 31 tháng 12 là 365 (hoặc 366).
    """
    return dt.timetuple().tm_yday

def solar_declination(doy: int) -> float:
    """
    Tính góc lệch mặt trời (solar declination angle) theo radian.
    Góc này thay đổi theo ngày trong năm do nghiêng trục Trái Đất.
    Nguồn: Duffie & Beckman (approximate)
    """
    return 0.409 * math.sin(0.0172 * (doy - 81)) # Công thức gần đúng

def eccentricity_correction(doy: int) -> float:
    """
    Tính hệ số điều chỉnh quỹ đạo lệch tâm của Trái Đất (eccentricity correction factor).
    Hệ số này mô tả sự thay đổi khoảng cách giữa Trái Đất và Mặt Trời trong năm.
    Nguồn: Duffie & Beckman
    """
    return 1 + 0.033 * math.cos(2 * math.pi * doy / 365)

def hour_angle_at_sunrise_sunset(latitude_rad: float, declination_rad: float) -> float:
    """
    Tính góc giờ lúc mặt trời mọc/lặn (sunrise/sunset hour angle) theo radian.
    Xác định thời lượng ban ngày.
    Trả về 0 nếu không có mặt trời mọc/lặn (đêm/ngày cực).
    """
    arg = -math.tan(latitude_rad) * math.tan(declination_rad)
    
    # Xử lý các trường hợp vùng cực nơi mặt trời có thể không mọc hoặc không lặn
    if arg > 1:  # Mặt trời luôn trên đường chân trời (ngày cực)
        return math.pi  # Tương đương với 12 giờ ban ngày (180 độ)
    if arg < -1: # Mặt trời luôn dưới đường chân trời (đêm cực)
        return 0     # Tương đương với 0 giờ ban ngày
    
    return math.acos(arg)

def calculate_daily_extraterrestrial_horizontal_radiation(
    latitude: float,
    dt: date
) -> float:
    """
    Tính tổng bức xạ mặt trời ngoài khí quyển trên mặt phẳng nằm ngang trong ngày (Ho).
    Đơn vị: MJ/m² (Megajoules trên mét vuông).
    
    Tham số:
        latitude (float): Vĩ độ của địa điểm tính toán (theo độ).
        dt (datetime.date): Ngày cụ thể cần tính toán.
        
    Trả về:
        float: Giá trị Ho theo MJ/m²/ngày.
    """
    
    latitude_rad = latitude * DEG_TO_RAD
    doy = get_day_of_year(dt)
    delta_rad = solar_declination(doy)
    E0 = eccentricity_correction(doy)
    omega_s_rad = hour_angle_at_sunrise_sunset(latitude_rad, delta_rad)

    # Công thức tính Ho theo Duffie & Beckman, Eq. 1.10.1 (đơn vị J/m^2/ngày)
    # Ho = (24*3600/pi) * G_sc * E0 * [omega_s*sin(phi)sin(delta) + cos(phi)cos(delta)sin(omega_s)]
    # Trong đó: omega_s, phi, delta phải là radian. G_sc là W/m^2.
    
    Ho_joules_per_m2_per_day = (
        (24 * 3600 / math.pi) * SOLAR_CONSTANT * E0 *
        (omega_s_rad * math.sin(latitude_rad) * math.sin(delta_rad) +
         math.cos(latitude_rad) * math.cos(delta_rad) * math.sin(omega_s_rad))
    )
    
    # Chuyển đổi từ Joules sang Megajoules (1 MJ = 1,000,000 J)
    Ho_MJ_per_m2_per_day = Ho_joules_per_m2_per_day / 1_000_000
    
    return Ho_MJ_per_m2_per_day

# --- Ví dụ sử dụng ---
if __name__ == "__main__":
    print("--- Tính toán Bức xạ Mặt trời Ngoài Khí quyển ---")

    # Ví dụ 1: Vĩ độ của Hà Nội, Việt Nam vào giữa mùa hè
    latitude_hanoi = 21.0285  # Vĩ độ Hà Nội
    test_date_hanoi_summer = date(2023, 7, 15) # Ngày 15 tháng 7
    ho_hanoi_summer = calculate_daily_extraterrestrial_horizontal_radiation(latitude_hanoi, test_date_hanoi_summer)
    
    print(f"\nTại Hà Nội ({latitude_hanoi}°N) vào ngày {test_date_hanoi_summer}:")
    print(f"  Bức xạ ngoài khí quyển (Ho): {ho_hanoi_summer:.2f} MJ/m²/ngày")
    print(f"  Tương đương: {ho_hanoi_summer / 3.6:.2f} kWh/m²/ngày") # 1 kWh = 3.6 MJ

    # Ví dụ 2: Vĩ độ của Hà Nội vào giữa mùa đông
    test_date_hanoi_winter = date(2023, 1, 15) # Ngày 15 tháng 1
    ho_hanoi_winter = calculate_daily_extraterrestrial_horizontal_radiation(latitude_hanoi, test_date_hanoi_winter)
    
    print(f"\nTại Hà Nội ({latitude_hanoi}°N) vào ngày {test_date_hanoi_winter}:")
    print(f"  Bức xạ ngoài khí quyển (Ho): {ho_hanoi_winter:.2f} MJ/m²/ngày")
    print(f"  Tương đương: {ho_hanoi_winter / 3.6:.2f} kWh/m²/ngày")

    # Ví dụ 3: Vĩ độ của TP. Hồ Chí Minh, gần xích đạo
    latitude_hcmc = 10.8231 # Vĩ độ TP. Hồ Chí Minh
    test_date_hcmc = date(2023, 7, 15)
    ho_hcmc = calculate_daily_extraterrestrial_horizontal_radiation(latitude_hcmc, test_date_hcmc)
    
    print(f"\nTại TP. Hồ Chí Minh ({latitude_hcmc}°N) vào ngày {test_date_hcmc}:")
    print(f"  Bức xạ ngoài khí quyển (Ho): {ho_hcmc:.2f} MJ/m²/ngày")
    print(f"  Tương đương: {ho_hcmc / 3.6:.2f} kWh/m²/ngày")
    
    # Ví dụ 4: Vĩ độ cao hơn (London) vào hạ chí (ngày dài nhất)
    latitude_london = 51.5 # Vĩ độ London
    test_date_london_summer_solstice = date(2023, 6, 21) # Hạ chí
    ho_london_summer_solstice = calculate_daily_extraterrestrial_horizontal_radiation(latitude_london, test_date_london_summer_solstice)
    
    print(f"\nTại London ({latitude_london}°N) vào ngày {test_date_london_summer_solstice} (Hạ chí):")
    print(f"  Bức xạ ngoài khí quyển (Ho): {ho_london_summer_solstice:.2f} MJ/m²/ngày")
    print(f"  Tương đương: {ho_london_summer_solstice / 3.6:.2f} kWh/m²/ngày")


    print("\n--- LƯU Ý QUAN TRỌNG VỀ BỨC XẠ THỰC TẾ ---")
    print("Kết quả trên là 'bức xạ ngoài khí quyển' (extraterrestrial radiation).")
    print("Đây là lượng bức xạ mặt trời đến được bề mặt khí quyển của Trái Đất.")
    print("Để có 'bức xạ mặt trời trên bề mặt' (surface radiation) thực tế, bạn cần tính đến:")
    print("1. Sự hấp thụ và tán xạ của khí quyển (hơi nước, khí, bụi, mây).")
    print("2. Các điều kiện thời tiết thực tế tại địa điểm và thời điểm (trời quang, mây mù, mưa).")
    
    print("\nĐể ước tính bức xạ thực tế, bạn thường sẽ nhân Ho với một 'hệ số rõ ràng' (clearness index) K_T.")
    print("Hệ số K_T này thường nằm trong khoảng:")
    print(" - 0.3 đến 0.4 cho ngày nhiều mây.")
    print(" - 0.5 đến 0.6 cho ngày có mây trung bình hoặc một phần quang đãng.")
    print(" - 0.7 đến 0.8 cho ngày trời quang, trong xanh.")
    
    print(f"\nVí dụ: Với Ho = {ho_hanoi_summer:.2f} MJ/m²/ngày tại Hà Nội vào mùa hè.")
    print(f"  - Nếu trời quang (K_T = 0.75), bức xạ ước tính: {ho_hanoi_summer * 0.75:.2f} MJ/m²/ngày (~ {(ho_hanoi_summer * 0.75)/3.6:.2f} kWh/m²/ngày)")
    print(f"  - Nếu trời có mây trung bình (K_T = 0.55), bức xạ ước tính: {ho_hanoi_summer * 0.55:.2f} MJ/m²/ngày (~ {(ho_hanoi_summer * 0.55)/3.6:.2f} kWh/m²/ngày)")
    print("\nĐể có kết quả chính xác hơn, cần sử dụng các mô hình khí tượng phức tạp hoặc các API dữ liệu bức xạ mặt trời thực tế (ví dụ: từ NASA, PVGIS, hoặc các trạm thời tiết địa phương).")
